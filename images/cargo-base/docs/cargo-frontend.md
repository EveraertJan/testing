# Building Cargo Front-ends

## Introduction

The [_Cargo-Base_ image](../README.md) includes a framework for providing web-based front-ends for Cargo services.

A Cargo Front-end web interface is built using [React][], [Bootstrap][] and [Redux][].
Common components are sourced from [React-Bootstrap][].

The source code is written in [ES6][] (ECMAScript 2015) and transpiled by [Babel][] to source code that common browsers can handle (using [babel-preset-es2015](https://www.npmjs.com/package/babel-preset-es2015)).
Babel is also made aware of our use of [React][] (with [babel-preset-react](https://www.npmjs.com/package/babel-preset-react) and [babel-plugin-react-require](https://www.npmjs.com/package/babel-plugin-react-require)).
Code conventions are asserted using [ESLint][].
The resulting code and other assets are packed with [WebPack][]. The resulting bundles are served by a http server.

The Cargo front-end bundles are normally packed at build-time by means of a _packer_ container. The packed front-end can be served by a dedicated http-server, e.g. a [Nginx][] container, or it may be served by the http-server fucntionality provided in the `CargoApp` base class. When using the built-in server, you can activate the _HTML-Watch-Mode_ during development. In this mode, whenever the source-code is modified, the served bundles are automatically updated accordingly.



## Project Configuration

To create a Cargo front-end you need to provide the necessary source code and configuration assets in the `html` directory in the Cargo image template. The following table lists the required assets in this directory.

| File or Directory | Function |
|:---- |:-------- |
| `build.html.sh` | Builds the Cargo Front-end using the _soyl-admin-packer_ container. |
| `build.packer.sh` | Builds the _soyl-admin-packer_ container that builds the Cargo Front-end. |
| `dc.yml` | The [Docker Compose][] file for the service's packer, such as the _soyl-admin-packer_ service that packs the [Soyl-Admin](../../admin/README.md)'s front-end. |
| `df.yml` | The DockerFile for the service's packer. |
| `package.json` | Includes the configuration of the dependencies of the front-end source code not provided by `cargo-base/package.json`. |
| `src/` | The source code of the Cargo front-end. |

The packed bundles and associated assets are saved in the `html/dist/` directory.

The `html/src/` directory should be mounted/copied to `/cargo/html/src/` and should contain the front-end source code, including:

| File | Function |
|:---- |:-------- |
| `main.jsx` | The default entrypoint for WebPack. |
| `styles/bootstrap-pre.scss` `styles/app.scss` | [Bootstrap-loader][] is configured (in `.bootstraprc`) to load `bootstrap-pre.scss` in which we customize the base Bootstrap variables before loading Bootstrap. After loading Bootstrap, this loader loads `app.scss` which holds the app-specific styles. |

The client app is configured by means of the _config_ object in `src/config.js`.
This config module is generated by the [webpack-masked-config-plugin](https://www.npmjs.com/package/webpack-masked-config-plugin), which is configured in `webpack.config.js`. It loads the same centralized configuration used by the other _business_ containers, masks it, extends is, and saves it as the loadable module.

The following common Cargo front-end source-code and configuration files are provided in `cargo-base/cargo-lib/html/`:

| Asset | Function |
|:----- |:-------- |
| `.bootstraprc` | The configuration for [Bootstrap][]. |
| `.eslintignore` | The ignore file for [ESLint][]. |
| `.eslintrc` | The configuration of [ESLint][]. |
| `configOptions.js` | Manage the _options_ object used in `createConfig.js`. |
| `createConfig.js` | Facilitates the creation of the [WebPack][] configuration object. |
| `dc.base.yml` | Defines base _packer_ service to extend concrete packer services from, such as the _soyl-admin-packer_ service that packs the [Soyl-Admin](../../admin/README.md)'s front-end. |
| `pack.js` | The script used by Cargo front-end packer services. |



## HTML-Watch-Mode

The web interface is served by the server provided in the CargoApp base class.
In the regular serving mode, the web assets are built upfront and served as static files.
This mode is the default mode when building and running the service.

The html-based interface can also be served in _HTML-Watch-Mode_ mode, which is useful during development.
In this mode the web assets are dynamically built.
The source code is watched and when it is changed, the assets are rebuilt and refreshed in the browser.
You can start this mode by setting the `HTML_WATCH_MODE` environment variable to `true` before starting the service, or simply by running the `watch.soyl-admin.html.sh` script in the `/scripts` directory.
You can also use the `watch.soyl-admin.sh` script which activates the watch-mode for both the Node app and the HTML-based interface.



## Source Code Conventions

- All source js files are written in [ES6][] (ECMAScript 2015) strict mode, respecting the following general conventions:
	- Use `import`/`export` instead of `require`
	- Use proper JS [classes](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Classes).
	- Use [`let`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/let)/[`const`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/const) block scoping instead of `var`.

- All custom React components are written as [ES6][] classes.
  - Don't forget to bind `this` to event/change handlers in components.


## System Configuration

The [React-Bootstrap][] library does not include Bootstrap itself, which is instead loaded using [Bootstrap-loader][], a WebPack loader that loads [bootstrap-sass][], the official Sass port of Bootstrap. Bootstrap-loader is triggered by adding it as an `entry` in `webpack.config.js` and is configured in `.bootstraprc`. This configuration is based on the [default configuration for BootStrap v3](https://raw.githubusercontent.com/shakacode/bootstrap-loader/master/.bootstraprc-3-default). Bootstrap-loader does not load the Bootstrap scripts (`scripts: false` in `.bootstraprc`) which allows us to avoid _jquery_.

[ESLint][] is used to lint the javascript source code. It is configured in `.eslintrc`. This configuration is based on [this template](https://gist.github.com/nkbt/9efd4facb391edbf8048). [ESLint-plugin-React](https://github.com/yannickcr/eslint-plugin-react) is used for React specific linting rules. See these [docs](http://eslint.org/docs/rules/) for more details on the linting rules.

The [WebPack Visualizer](https://github.com/chrisbateman/webpack-visualizer) is installed and generates the `html/bundle/stats.html` page.




### Resources

The following resources were consulted when setting up the Webpack/Babel/React/Bootstrap framework:

#### React
- [List of React tools](https://github.com/facebook/react/wiki/Complementary-Tools)
- [React Component Library](https://leesalminen.github.io/)

#### Bootstrap
- [Bootstrap variables](http://getbootstrap.com/customize/#less-variables)

#### Webpack
- [Webpack Dev Server](https://webpack.github.io/docs/webpack-dev-server.html) 
- [Webpack Optimization](https://webpack.github.io/docs/optimization.html)
- [Webpack Build Performance](https://github.com/webpack/docs/wiki/build-performance)
- [React Hot Loader](http://gaearon.github.io/react-hot-loader/getstarted/)
- [Webpack and React - survivejs](http://survivejs.com/webpack_react/webpack_and_react/)
- [Webpack your bags](http://blog.madewithlove.be/post/webpack-your-bags/)



## Tips & Tricks

- TODO: During development, use the [React Developer Tools](http://facebook.github.io/react/blog/2015/09/02/new-react-developer-tools.html).







[Babel]: https://babeljs.io
[Bootstrap]: http://getbootstrap.com
[Bootstrap-loader]: https://github.com/shakacode/bootstrap-loader
[bootstrap-sass]: https://github.com/twbs/bootstrap-sass
[Cargo]: ../../docs/dev/cargo-containers.md
[Docker]: https://www.docker.com
[Docker Compose]: https://www.docker.com/products/docker-compose
[ES6]: http://www.ecma-international.org/publications/standards/Ecma-262.htm
[ESLint]: http://eslint.org
[Koa]: http://koajs.com
[Nginx]: http://nginx.org
[Node.js]: https://nodejs.org
[React]: https://facebook.github.io/react/
[React-Bootstrap]: http://react-bootstrap.github.io
[Redux]: http://redux.js.org
[WebPack]: https://webpack.github.io
